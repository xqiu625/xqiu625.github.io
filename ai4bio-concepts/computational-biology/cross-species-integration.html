<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cross-Species Data Integration - AI4Bio Concepts</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Lato', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            line-height: 1.8;
            color: #333;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        .navbar {
            background-color: #ffffff;
            border-bottom: 1px solid #e7e7e7;
            padding: 10px 0;
        }
        .navbar-nav {
            list-style-type: none;
            padding: 0;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .navbar-nav li {
            margin: 0 15px;
        }
        .navbar-nav a {
            color: #666666;
            text-decoration: none;
            font-weight: bold;
            font-size: 16px;
        }
        .home-link {
            color: #27ae60 !important;
        }
        .header {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            padding: 40px;
            border-radius: 15px;
            margin: 30px 0;
            text-align: center;
        }
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 2.5em;
        }
        .header p {
            margin: 5px 0;
            font-size: 1.1em;
            opacity: 0.9;
        }
        .paper-ref {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 0.95em;
        }
        .content-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin: 25px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .content-section h2 {
            color: #27ae60;
            border-bottom: 3px solid #27ae60;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .content-section h3 {
            color: #229954;
            margin-top: 25px;
        }
        .concept-box {
            background: #f8f9fa;
            border-left: 5px solid #27ae60;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .concept-box.challenge {
            border-left-color: #e74c3c;
        }
        .concept-box.method1 {
            border-left-color: #3498db;
        }
        .concept-box.method2 {
            border-left-color: #f39c12;
        }
        .concept-box.method3 {
            border-left-color: #9b59b6;
        }
        .highlight-box {
            background: #d4edda;
            border: 1px solid #28a745;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .highlight-box strong {
            color: #155724;
        }
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .warning-box strong {
            color: #856404;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .comparison-table th {
            background: #27ae60;
            color: white;
        }
        .comparison-table tr:hover {
            background: #f5f5f5;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-card .number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-card .label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .timeline {
            position: relative;
            padding: 20px 0;
            margin: 30px 0;
        }
        .timeline-item {
            position: relative;
            padding-left: 60px;
            margin-bottom: 30px;
        }
        .timeline-icon {
            position: absolute;
            left: 0;
            width: 40px;
            height: 40px;
            background: #27ae60;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .timeline-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #27ae60;
        }
        .species-divergence {
            display: flex;
            align-items: center;
            justify-content: space-around;
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .species-box {
            text-align: center;
            padding: 15px;
        }
        .species-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }
        .divergence-arrow {
            font-size: 2em;
            color: #27ae60;
        }
        .method-card {
            background: white;
            border: 2px solid #27ae60;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .method-card h4 {
            color: #27ae60;
            margin-top: 0;
        }
        .pros-cons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .pros, .cons {
            padding: 15px;
            border-radius: 8px;
        }
        .pros {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }
        .cons {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        .decision-tree {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .decision-node {
            background: white;
            border: 2px solid #27ae60;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            position: relative;
        }
        .decision-arrow {
            text-align: center;
            color: #27ae60;
            font-size: 1.5em;
            margin: 10px 0;
        }
        .back-link {
            display: inline-block;
            margin: 20px 0;
            padding: 10px 20px;
            background: #27ae60;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .back-link:hover {
            background: #229954;
            transform: translateX(-5px);
        }
        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 10px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
            margin: 15px 0;
        }
        .code-block .comment {
            color: #75715e;
        }
        .code-block .keyword {
            color: #f92672;
        }
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            .pros-cons {
                grid-template-columns: 1fr;
            }
            .species-divergence {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <ul class="navbar-nav">
                <li><a href="../index.html" class="home-link"><i class="fas fa-book"></i> AI4Bio Concepts Handbook</a></li>
                <li><a href="../../"><i class="fas fa-home"></i> Xinru's Homepage</a></li>
            </ul>
        </div>
    </nav>

    <main role="main">
        <div class="container">
            <div class="header">
                <h1><i class="fas fa-project-diagram"></i> Cross-Species Data Integration Strategies</h1>
                <p>How to integrate genomics data across evolutionarily distant species</p>
                <div class="paper-ref">
                    <strong>Key Example:</strong> SATURN (Rosen et al. 2024) integrates frog ↔ zebrafish (350M years divergence) and human ↔ mouse ↔ lemur atlases using protein language models
                </div>
            </div>

            <!-- The Challenge -->
            <div class="content-section">
                <h2><i class="fas fa-exclamation-triangle"></i> The Challenge</h2>
                
                <div class="concept-box challenge">
                    <h3>Why Cross-Species Integration Is Hard</h3>
                    <p><strong>Core Problem:</strong> Different species have different genes. A gene present in Species A may not exist in Species B, or may have diverged so much that traditional matching methods fail.</p>
                </div>

                <h3>Evolutionary Timeline Example</h3>
                <div class="species-divergence">
                    <div class="species-box">
                        <div class="species-icon">🐸</div>
                        <strong>Frog</strong><br>
                        <small>~20,000 genes</small>
                    </div>
                    <div class="divergence-arrow">
                        ←<br>
                        <small style="font-size: 0.5em;">350 million years</small><br>
                        →
                    </div>
                    <div class="species-box">
                        <div class="species-icon">🐠</div>
                        <strong>Zebrafish</strong><br>
                        <small>~26,000 genes</small>
                    </div>
                </div>

                <div class="species-divergence">
                    <div class="species-box">
                        <div class="species-icon">👤</div>
                        <strong>Human</strong><br>
                        <small>~25,000 genes</small>
                    </div>
                    <div class="divergence-arrow">
                        ←<br>
                        <small style="font-size: 0.5em;">90 million years</small><br>
                        →
                    </div>
                    <div class="species-box">
                        <div class="species-icon">🐭</div>
                        <strong>Mouse</strong><br>
                        <small>~22,000 genes</small>
                    </div>
                </div>

                <h3>What Happens to Genes Over Time</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="number">1:1</div>
                        <div class="label">Orthologs (conserved genes)</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">1:Many</div>
                        <div class="label">Paralogs (duplications)</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">Lost</div>
                        <div class="label">Gene loss events</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">Novel</div>
                        <div class="label">Lineage-specific genes</div>
                    </div>
                </div>

                <div class="warning-box">
                    <strong><i class="fas fa-exclamation-circle"></i> The Homolog Problem:</strong> 
                    Human-Mouse share ~17,000 1:1 orthologs out of ~25,000 human genes (68%). Human-Mouse-Lemur (3 species) might only have ~12,000 shared orthologs (48%). As you add more species, the common gene set shrinks dramatically.
                </div>
            </div>

            <!-- Three Approaches -->
            <div class="content-section">
                <h2><i class="fas fa-sitemap"></i> Three Integration Strategies</h2>
                
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-icon">1</div>
                        <div class="timeline-content">
                            <h4>One-to-One Homolog Subsetting (2010s)</h4>
                            <p>Restrict analysis to genes with clear 1:1 orthologs across all species</p>
                            <p><strong>Used by:</strong> Harmony, scVI, Scanorama, most batch correction methods</p>
                        </div>
                    </div>
                    
                    <div class="timeline-item">
                        <div class="timeline-icon">2</div>
                        <div class="timeline-content">
                            <h4>Sequence Alignment Graphs (2020-2021)</h4>
                            <p>Build weighted gene graphs using BLASTP sequence similarity</p>
                            <p><strong>Used by:</strong> SAMap (Tarashansky et al. 2021)</p>
                        </div>
                    </div>
                    
                    <div class="timeline-item">
                        <div class="timeline-icon">3</div>
                        <div class="timeline-content">
                            <h4>Functional Embeddings (2024+)</h4>
                            <p>Represent genes by protein function using language models</p>
                            <p><strong>Used by:</strong> SATURN (Rosen et al. 2024)</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Method 1: One-to-One Homologs -->
            <div class="content-section">
                <h2><i class="fas fa-layer-group"></i> Method 1: One-to-One Homolog Subsetting</h2>
                
                <div class="concept-box method1">
                    <h3>Core Idea</h3>
                    <p>Only use genes that have a single clear ortholog in every species being integrated. Query databases like ENSEMBL or NCBI HomoloGene to find these 1:1 relationships.</p>
                </div>

                <h3>How It Works</h3>
                <div class="code-block">
<span class="comment"># Example: Find 1:1 orthologs between human and mouse</span>
<span class="keyword">from</span> biomart <span class="keyword">import</span> BiomartServer

<span class="comment"># Query ENSEMBL for ortholog mappings</span>
server = BiomartServer(<span class="string">"http://www.ensembl.org/biomart"</span>)
mart = server.datasets[<span class="string">'hsapiens_gene_ensembl'</span>]

attributes = [<span class="string">'external_gene_name'</span>, 
              <span class="string">'mmusculus_homolog_ensembl_gene'</span>,
              <span class="string">'mmusculus_homolog_orthology_type'</span>]

response = mart.search({<span class="string">'attributes'</span>: attributes})

<span class="comment"># Filter for 1:1 orthologs only</span>
one_to_one = [
    (human_gene, mouse_gene) 
    <span class="keyword">for</span> human_gene, mouse_gene, orth_type <span class="keyword">in</span> response
    <span class="keyword">if</span> orth_type == <span class="string">'ortholog_one2one'</span>
]

<span class="comment"># Subset expression matrices to common genes</span>
human_expr_subset = human_expr[:, human_genes.isin(one_to_one_human)]
mouse_expr_subset = mouse_expr[:, mouse_genes.isin(one_to_one_mouse)]
                </div>

                <div class="pros-cons">
                    <div class="pros">
                        <h4><i class="fas fa-check-circle"></i> Pros</h4>
                        <ul>
                            <li>Simple and straightforward</li>
                            <li>Biologically interpretable</li>
                            <li>Works with any batch correction method</li>
                            <li>High confidence in gene matches</li>
                        </ul>
                    </div>
                    <div class="cons">
                        <h4><i class="fas fa-times-circle"></i> Cons</h4>
                        <ul>
                            <li><strong>Massive gene loss:</strong> 50-80% of genes discarded</li>
                            <li>Excludes lineage-specific genes</li>
                            <li>Ignores many-to-many relationships (paralogs)</li>
                            <li>Worse with more species (intersection shrinks)</li>
                        </ul>
                    </div>
                </div>

                <h3>Performance Example: SATURN Benchmark</h3>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Method</th>
                            <th>Uses 1:1 Homologs?</th>
                            <th>Genes Used</th>
                            <th>Accuracy (Zebrafish→Frog)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Harmony</strong></td>
                            <td>Yes</td>
                            <td>~8,000 shared orthologs</td>
                            <td>32.5%</td>
                        </tr>
                        <tr>
                            <td><strong>scVI</strong></td>
                            <td>Yes</td>
                            <td>~8,000 shared orthologs</td>
                            <td>30.1%</td>
                        </tr>
                        <tr>
                            <td><strong>Scanorama</strong></td>
                            <td>Yes</td>
                            <td>~8,000 shared orthologs</td>
                            <td>11.2%</td>
                        </tr>
                        <tr style="background: #d4edda;">
                            <td><strong>SATURN</strong></td>
                            <td><strong>No (all genes)</strong></td>
                            <td><strong>~46,000 total genes</strong></td>
                            <td><strong>85.8%</strong></td>
                        </tr>
                    </tbody>
                </table>

                <div class="warning-box">
                    <strong><i class="fas fa-exclamation-triangle"></i> Key Limitation:</strong> 
                    Frog has ~20,000 genes, zebrafish ~26,000 genes. Using only 1:1 orthologs means discarding 82% of frog genes and 69% of zebrafish genes!
                </div>
            </div>

            <!-- Method 2: Sequence Alignment -->
            <div class="content-section">
                <h2><i class="fas fa-align-center"></i> Method 2: Sequence Alignment Graphs</h2>
                
                <div class="concept-box method2">
                    <h3>Core Idea</h3>
                    <p>Build a weighted graph where genes are nodes and edges represent sequence similarity from BLASTP. Genes don't need 1:1 relationships—any gene with sufficient similarity can be connected.</p>
                </div>

                <h3>How SAMap Works</h3>
                <ol>
                    <li><strong>Run BLASTP:</strong> All-vs-all protein sequence alignment across species
                        <div class="code-block">
<span class="comment"># Run BLASTP for all gene pairs</span>
blastp -query frog_proteins.fasta \
       -db zebrafish_proteins.fasta \
       -outfmt 6 \
       -evalue 1e-5 \
       -out frog_zebrafish_blastp.txt
                        </div>
                    </li>
                    <li><strong>Build Gene Graph:</strong> Create edges with weights = BLAST bit score / max possible score</li>
                    <li><strong>Graph Neural Network:</strong> Learn gene embeddings that incorporate cross-species edges</li>
                    <li><strong>Integrate Cells:</strong> Map cells using gene embeddings + expression</li>
                </ol>

                <div class="pros-cons">
                    <div class="pros">
                        <h4><i class="fas fa-check-circle"></i> Pros</h4>
                        <ul>
                            <li>Handles many-to-many relationships (paralogs)</li>
                            <li>Uses more genes than 1:1 method</li>
                            <li>Weighted edges capture confidence</li>
                            <li>Can include genes without perfect matches</li>
                        </ul>
                    </div>
                    <div class="cons">
                        <h4><i class="fas fa-times-circle"></i> Cons</h4>
                        <ul>
                            <li><strong>Threshold-dependent:</strong> Need arbitrary e-value cutoff</li>
                            <li><strong>Poor for remote species:</strong> Fails at <30% sequence identity</li>
                            <li><strong>Misses remote homology:</strong> Functional similarity without sequence similarity</li>
                            <li>Still only 39.2% accuracy on frog-zebrafish</li>
                        </ul>
                    </div>
                </div>

                <h3>Why Sequence Alignment Fails for Remote Species</h3>
                <div class="concept-box">
                    <p><strong>Example: Claudin genes in frog and zebrafish ionocytes</strong></p>
                    <ul>
                        <li><strong>Biological reality:</strong> Claudins are known markers of gill ionocytes in zebrafish</li>
                        <li><strong>BLASTP results:</strong> Frog and zebrafish claudins don't meet significance threshold (e-value > 1e-5)</li>
                        <li><strong>Consequence:</strong> SAMap cannot match these functionally related genes</li>
                        <li><strong>SATURN solution:</strong> ESM2 embeddings group claudins together despite <30% sequence identity</li>
                    </ul>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="number">60-80%</div>
                        <div class="label">Sequence identity needed for confident BLASTP matches</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">30-50%</div>
                        <div class="label">Typical sequence identity for frog-zebrafish orthologs</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">1e-5</div>
                        <div class="label">Common e-value threshold (arbitrary)</div>
                    </div>
                </div>
            </div>

            <!-- Method 3: Functional Embeddings -->
            <div class="content-section">
                <h2><i class="fas fa-brain"></i> Method 3: Functional Embeddings (Protein Language Models)</h2>
                
                <div class="concept-box method3">
                    <h3>Core Idea</h3>
                    <p>Don't match genes by sequence—represent them by <strong>what they do</strong>. Use protein language models (like ESM2) trained on 250M proteins to create functional embeddings that capture similarity even without sequence conservation.</p>
                </div>

                <h3>How SATURN Works</h3>
                <ol>
                    <li><strong>Generate Protein Embeddings:</strong> Pass all proteins through ESM2 → 5120-dim vectors</li>
                    <li><strong>Create Macrogenes:</strong> Cluster embeddings → groups of functionally related genes</li>
                    <li><strong>Learn Weights:</strong> Gene-to-macrogene weights based on embedding similarity</li>
                    <li><strong>Integrate:</strong> All species share the macrogene space (no gene matching needed!)</li>
                </ol>

                <div class="highlight-box">
                    <strong><i class="fas fa-lightbulb"></i> Key Innovation:</strong> 
                    Instead of asking "Does frog gene X match zebrafish gene Y?", ask "What biological functions do these genes perform?" Genes with similar functions (e.g., DNA repair, ion transport) cluster together even if their sequences have diverged.
                </div>

                <h3>Concrete Example: Ionocyte Markers</h3>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Macrogene</th>
                            <th>Frog Genes</th>
                            <th>Zebrafish Genes</th>
                            <th>Shared Function</th>
                            <th>BLASTP Match?</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Foxi</strong></td>
                            <td>Foxi1, Foxi3a</td>
                            <td>foxi1, foxg1a, foxg1</td>
                            <td>Fox transcription factors</td>
                            <td>✅ Yes</td>
                        </tr>
                        <tr>
                            <td><strong>Dmrt2</strong></td>
                            <td>Dmrt2</td>
                            <td>dmrt2a, kank1</td>
                            <td>Development, ionocyte markers</td>
                            <td>✅ Partial</td>
                        </tr>
                        <tr style="background: #d4edda;">
                            <td><strong>Cldn</strong></td>
                            <td>Cldn4, Clde</td>
                            <td>cldna, cldnh, cldnb</td>
                            <td>Claudins (tight junction proteins)</td>
                            <td><strong>❌ No (ESM2 finds them!)</strong></td>
                        </tr>
                        <tr>
                            <td><strong>Ubp1</strong></td>
                            <td>Ubp1</td>
                            <td>grhl3, grhl1, grlh2a, tp63</td>
                            <td>Grainyhead-like TFs, epithelial</td>
                            <td>✅ Partial</td>
                        </tr>
                        <tr>
                            <td><strong>Atp6v0</strong></td>
                            <td>Atp6v0c</td>
                            <td>atp6v0ca, atp6v0b</td>
                            <td>V-ATPase (ion pump)</td>
                            <td>✅ Yes</td>
                        </tr>
                    </tbody>
                </table>

                <div class="pros-cons">
                    <div class="pros">
                        <h4><i class="fas fa-check-circle"></i> Pros</h4>
                        <ul>
                            <li><strong>Uses ALL genes</strong> from all species (no subsetting!)</li>
                            <li>Captures remote homology (<30% sequence identity)</li>
                            <li>Finds functionally related non-homologs</li>
                            <li>Interpretable (macrogenes = gene modules)</li>
                            <li>Scales to many species (no intersection shrinkage)</li>
                        </ul>
                    </div>
                    <div class="cons">
                        <h4><i class="fas fa-times-circle"></i> Cons</h4>
                        <ul>
                            <li>Requires high-quality reference proteomes</li>
                            <li>Computationally expensive (ESM2 = 80GB GPU memory)</li>
                            <li>Cannot represent non-coding RNAs</li>
                            <li>Less mature than homolog-based methods</li>
                        </ul>
                    </div>
                </div>

                <h3>Performance Comparison</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="number">85.8%</div>
                        <div class="label">SATURN (Functional)</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">39.2%</div>
                        <div class="label">SAMap (Sequence)</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">32.5%</div>
                        <div class="label">Harmony (1:1 Homologs)</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">119%</div>
                        <div class="label">Improvement over best baseline</div>
                    </div>
                </div>
            </div>

            <!-- Decision Tree -->
            <div class="content-section">
                <h2><i class="fas fa-code-branch"></i> Which Method Should You Use?</h2>
                
                <div class="decision-tree">
                    <div class="decision-node">
                        <strong>Q: How evolutionarily distant are your species?</strong>
                    </div>
                    <div class="decision-arrow">↓</div>
                    
                    <div class="decision-node">
                        <strong>Close (<100M years, e.g., Human-Mouse)</strong>
                        <ul>
                            <li>✅ <strong>Method 1 (1:1 Homologs)</strong> works well</li>
                            <li>~60-70% genes retained</li>
                            <li>Use with Harmony, scVI, Scanorama</li>
                            <li>Fast, simple, well-tested</li>
                        </ul>
                    </div>
                    
                    <div class="decision-node">
                        <strong>Moderate (100-250M years, e.g., Human-Chicken)</strong>
                        <ul>
                            <li>⚠️ <strong>Method 2 (Sequence Alignment)</strong> may work</li>
                            <li>~40-50% genes retained</li>
                            <li>Use SAMap with careful threshold tuning</li>
                            <li>Consider Method 3 if performance is poor</li>
                        </ul>
                    </div>
                    
                    <div class="decision-node">
                        <strong>Remote (>250M years, e.g., Frog-Zebrafish)</strong>
                        <ul>
                            <li>✅ <strong>Method 3 (Functional Embeddings)</strong> required</li>
                            <li>100% genes retained</li>
                            <li>Use SATURN or similar protein LM approach</li>
                            <li>Higher computational cost but much better performance</li>
                        </ul>
                    </div>
                </div>

                <h3>Additional Considerations</h3>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Scenario</th>
                            <th>Recommended Method</th>
                            <th>Rationale</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>3+ species integration</strong></td>
                            <td>Method 3 (Functional)</td>
                            <td>Method 1 loses 70-80% genes with 3+ species</td>
                        </tr>
                        <tr>
                            <td><strong>Lineage-specific genes important</strong></td>
                            <td>Method 3 (Functional)</td>
                            <td>Methods 1 & 2 exclude species-specific genes</td>
                        </tr>
                        <tr>
                            <td><strong>Limited compute resources</strong></td>
                            <td>Method 1 (1:1 Homologs)</td>
                            <td>No GPU needed, runs on laptop</td>
                        </tr>
                        <tr>
                            <td><strong>Poor reference proteome</strong></td>
                            <td>Method 2 (Sequence)</td>
                            <td>BLASTP works with partial proteomes</td>
                        </tr>
                        <tr>
                            <td><strong>Non-coding RNA analysis</strong></td>
                            <td>Method 1 or 2</td>
                            <td>Method 3 requires protein-coding genes</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Best Practices -->
            <div class="content-section">
                <h2><i class="fas fa-check-square"></i> Best Practices</h2>
                
                <h3>Before Integration</h3>
                <div class="concept-box">
                    <ol>
                        <li><strong>Check divergence time:</strong> Use TimeTree (timetree.org) to estimate species separation</li>
                        <li><strong>Assess homolog coverage:</strong> Query ENSEMBL/NCBI to see % genes with 1:1 orthologs</li>
                        <li><strong>Quality control individual datasets:</strong> Remove low-quality cells within each species first</li>
                        <li><strong>Normalize appropriately:</strong> Use library size normalization, log-transform</li>
                    </ol>
                </div>

                <h3>During Integration</h3>
                <div class="concept-box">
                    <ol>
                        <li><strong>Test multiple methods:</strong> Try all applicable approaches on a small test set</li>
                        <li><strong>Use cell type annotations:</strong> Weakly supervised methods (SAMap, SATURN) work better than unsupervised</li>
                        <li><strong>Validate biologically:</strong> Check if known marker genes align correctly</li>
                        <li><strong>Assess batch mixing vs. biology:</strong> Use SCIB metrics (batch integration + bio conservation)</li>
                    </ol>
                </div>

                <h3>After Integration</h3>
                <div class="concept-box">
                    <ol>
                        <li><strong>Label transfer validation:</strong> Use cross-species nearest neighbors to assess alignment quality</li>
                        <li><strong>Marker gene checking:</strong> Verify that cell type markers cluster appropriately</li>
                        <li><strong>Species-specific cell types:</strong> Ensure methods preserve species-unique populations</li>
                        <li><strong>Quantitative metrics:</strong> Report accuracy, F1, precision, recall with confidence intervals</li>
                    </ol>
                </div>

                <div class="warning-box">
                    <strong><i class="fas fa-exclamation-circle"></i> Common Pitfall:</strong> 
                    Don't just look at UMAP plots! Species mixing in 2D visualization doesn't guarantee correct cell type alignment. Always validate quantitatively with label transfer or marker gene analysis.
                </div>
            </div>

            <!-- Case Studies -->
            <div class="content-section">
                <h2><i class="fas fa-microscope"></i> Real-World Case Studies</h2>
                
                <div class="method-card">
                    <h4>Case Study 1: Human-Mouse-Lemur Atlas (SATURN)</h4>
                    <p><strong>Challenge:</strong> Integrate 335,000 cells across 9 tissues from 3 mammalian species</p>
                    <p><strong>Divergence:</strong> Human-Mouse = 90M years, Human-Lemur = 75M years</p>
                    <p><strong>Method Used:</strong> Functional embeddings (SATURN with ESM2)</p>
                    <p><strong>Results:</strong></p>
                    <ul>
                        <li>Successfully aligned major cell types (T cells, B cells, muscle cells)</li>
                        <li>Discovered misannotations (mouse macrophages → granulocytes based on Cd55/Cd74)</li>
                        <li>Fine-grained alignment (human memory B cells vs. naive B cells via Cd19)</li>
                        <li>Preserved species-specific cell types (human epithelial, erythrocytes)</li>
                    </ul>
                </div>

                <div class="method-card">
                    <h4>Case Study 2: Frog-Zebrafish Embryogenesis (SATURN)</h4>
                    <p><strong>Challenge:</strong> Integrate 160,000 cells from developmental time series</p>
                    <p><strong>Divergence:</strong> 350M years (very remote)</p>
                    <p><strong>Method Used:</strong> Functional embeddings (SATURN with ESM2)</p>
                    <p><strong>Key Findings:</strong></p>
                    <ul>
                        <li>85.8% label transfer accuracy (vs. 39.2% for SAMap sequence-based)</li>
                        <li>Aligned conserved cell types: neural crest, blood, endoderm</li>
                        <li>Aligned related but not identical: zebrafish dorsal organizer ↔ frog Spemann organizer</li>
                        <li>Found claudin ionocyte markers missed by BLASTP (no sequence match but functional similarity)</li>
                    </ul>
                </div>

                <div class="method-card">
                    <h4>Case Study 3: 5-Species Glaucoma Atlas (SATURN)</h4>
                    <p><strong>Challenge:</strong> Integrate 50,000 cells from eye tissue across human, two macaque species, mouse, and pig</p>
                    <p><strong>Divergence:</strong> Human-Macaque = 25M years, Human-Mouse = 90M years, Human-Pig = 96M years</p>
                    <p><strong>Method Used:</strong> Functional embeddings (SATURN with ESM2)</p>
                    <p><strong>Discovery:</strong></p>
                    <ul>
                        <li>Reannotated cell types based on cross-species comparison</li>
                        <li>Found human MYOC (glaucoma gene) clusters separately from other species' Myoc</li>
                        <li>Human MYOC groups with human A2M (also glaucoma-associated), suggesting functional divergence</li>
                        <li>Demonstrates protein embeddings can identify species-specific protein function differences</li>
                    </ul>
                </div>
            </div>

            <!-- Implementation -->
            <div class="content-section">
                <h2><i class="fas fa-code"></i> Implementation Guide</h2>
                
                <h3>Method 1: One-to-One Homologs</h3>
                <div class="code-block">
<span class="keyword">import</span> scanpy <span class="keyword">as</span> sc
<span class="keyword">import</span> pandas <span class="keyword">as</span> pd

<span class="comment"># Load pre-computed orthologs from ENSEMBL</span>
orthologs = pd.read_csv(<span class="string">'human_mouse_1to1_orthologs.csv'</span>)

<span class="comment"># Subset expression matrices</span>
adata_human_subset = adata_human[:, adata_human.var_names.isin(orthologs.human_gene)]
adata_mouse_subset = adata_mouse[:, adata_mouse.var_names.isin(orthologs.mouse_gene)]

<span class="comment"># Rename mouse genes to human orthologs for matching</span>
gene_map = dict(zip(orthologs.mouse_gene, orthologs.human_gene))
adata_mouse_subset.var_names = [gene_map.get(g, g) <span class="keyword">for</span> g <span class="keyword">in</span> adata_mouse_subset.var_names]

<span class="comment"># Now both have same gene names - concatenate and batch correct</span>
adata_combined = sc.concat([adata_human_subset, adata_mouse_subset])
sc.external.pp.harmony_integrate(adata_combined, <span class="string">'species'</span>)
                </div>

                <h3>Method 2: Sequence Alignment (SAMap)</h3>
                <div class="code-block">
<span class="keyword">from</span> samap.mapping <span class="keyword">import</span> SAMAP

<span class="comment"># Initialize SAMap with BLASTP results</span>
sm = SAMAP(
    adata_dict={<span class="string">'frog'</span>: adata_frog, <span class="string">'zebrafish'</span>: adata_zebrafish},
    f_maps=<span class="string">'frog_zebrafish_blast.txt'</span>,  <span class="comment"># BLASTP output</span>
)

<span class="comment"># Run integration with cell type labels</span>
sm.run(
    use_labels=True,  <span class="comment"># Weakly supervised mode</span>
    label_key=<span class="string">'cell_type'</span>,
)

<span class="comment"># Get integrated embeddings</span>
embeddings = sm.adata.obsm[<span class="string">'X_umap'</span>]
                </div>

                <h3>Method 3: Functional Embeddings (SATURN)</h3>
                <div class="code-block">
<span class="keyword">from</span> saturn <span class="keyword">import</span> SATURN
<span class="keyword">import</span> torch

<span class="comment"># Generate protein embeddings (once, can cache)</span>
<span class="keyword">from</span> esm <span class="keyword">import</span> pretrained
model, alphabet = pretrained.esm2_t48_15B_UR50D()
protein_embeddings = generate_embeddings(model, gene_sequences)

<span class="comment"># Initialize SATURN</span>
saturn = SATURN(
    adatas=[adata_frog, adata_zebrafish],
    protein_embeddings=protein_embeddings,
    n_macrogenes=2000,
)

<span class="comment"># Pretrain with autoencoder</span>
saturn.pretrain(n_epochs=50)

<span class="comment"># Fine-tune with metric learning</span>
saturn.train(
    label_key=<span class="string">'cell_type'</span>,  <span class="comment"># Within-species labels only</span>
    n_epochs=30,
)

<span class="comment"># Get integrated embeddings</span>
embeddings = saturn.get_latent()
                </div>
            </div>

            <!-- Future Directions -->
            <div class="content-section">
                <h2><i class="fas fa-rocket"></i> Future Directions</h2>
                
                <h3>Emerging Approaches</h3>
                <div class="concept-box">
                    <ul>
                        <li><strong>Multi-modal protein representations:</strong> Combine sequence (ESM2) + structure (AlphaFold) + localization (protein atlas)</li>
                        <li><strong>RNA structure embeddings:</strong> Extend functional embeddings to non-coding RNAs using RNA structure prediction</li>
                        <li><strong>Evolutionary trajectories:</strong> Model gene function evolution through embedding space paths</li>
                        <li><strong>Domain-specific fine-tuning:</strong> Adapt protein LMs to species-specific proteomes for better performance</li>
                        <li><strong>Temporal integration:</strong> Integrate developmental time series across species (conserved developmental programs)</li>
                    </ul>
                </div>

                <h3>Open Research Questions</h3>
                <ol>
                    <li>Can we integrate plants and animals using functional embeddings? (1.5 billion years divergence)</li>
                    <li>How to incorporate genetic variation (SNPs, indels) into cross-species embeddings?</li>
                    <li>What's the optimal number of macrogenes/functional modules for different biological questions?</li>
                    <li>Can we use cross-species integration to predict gene function for unannotated genes?</li>
                    <li>How to extend to spatial transcriptomics across species?</li>
                </ol>
            </div>

            <!-- Related Concepts -->
            <div class="content-section">
                <h2><i class="fas fa-link"></i> Related Concepts</h2>
                
                <div class="concept-box">
                    <h3>In This Handbook:</h3>
                    <ul>
                        <li><strong>Foundation Models:</strong> 
                            <a href="../foundation-models/protein-language-models-gene-representation.html">Protein Language Models for Gene Representation</a> - 
                            Deep dive into ESM2 and how it enables Method 3
                        </li>
                        <li><strong>Foundation Models:</strong> 
                            <a href="../foundation-models/self-verification-agents.html">Self-Verification Agents</a> - 
                            Another use of external knowledge (databases) to improve AI systems
                        </li>
                        <li><strong>Machine Learning:</strong> 
                            <a href="../machine-learning/weakly-supervised-metric-learning.html">Weakly Supervised Metric Learning</a> (Coming Soon) - 
                            How SATURN and SAMap use within-species labels for cross-species integration
                        </li>
                    </ul>
                </div>

                <div class="concept-box">
                    <h3>Key Papers:</h3>
                    <ul>
                        <li><strong>SATURN (Method 3):</strong> Rosen et al. (2024). Toward universal cell embeddings: integrating single-cell RNA-seq datasets across species with SATURN. <em>Nature Methods</em></li>
                        <li><strong>SAMap (Method 2):</strong> Tarashansky et al. (2021). Mapping single-cell atlases throughout metazoa unravels cell type evolution. <em>eLife</em></li>
                        <li><strong>Harmony (Method 1):</strong> Korsunsky et al. (2019). Fast, sensitive and accurate integration of single-cell data with Harmony. <em>Nature Methods</em></li>
                        <li><strong>ESM2:</strong> Lin et al. (2023). Evolutionary-scale prediction of atomic-level protein structure with a language model. <em>Science</em></li>
                    </ul>
                </div>
            </div>

            <a href="../index.html" class="back-link"><i class="fas fa-arrow-left"></i> Back to Handbook</a>
        </div>
    </main>

    <footer>
        <div class="container" style="text-align: center; margin-top: 40px; padding: 20px; color: #666;">
            <p>Part of <a href="../../" style="color: #27ae60;">Xinru Qiu's</a> AI4Bio Concepts Handbook</p>
            <p style="font-size: 0.9em; margin-top: 10px;">Last updated: January 2025</p>
        </div>
    </footer>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TranscriptFormer Dual Decoder Heads - AI4Bio Concepts</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Lato', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            line-height: 1.8;
            color: #333;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        .navbar {
            background-color: #ffffff;
            border-bottom: 1px solid #e7e7e7;
            padding: 10px 0;
        }
        .navbar-nav {
            list-style-type: none;
            padding: 0;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .navbar-nav li {
            margin: 0 15px;
        }
        .navbar-nav a {
            color: #666666;
            text-decoration: none;
            font-weight: bold;
            font-size: 16px;
        }
        .home-link {
            color: #FCD1D2 !important;
        }
        .header {
            background: linear-gradient(135deg, #9fB7E6 0%, #BCDAEE 25%, #FCED92 50%, #FCD1D2 75%, #DCCBD8 100%);
            color: #333;
            padding: 40px;
            border-radius: 15px;
            margin: 30px 0;
            text-align: center;
        }
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 2.5em;
            color: #000;
        }
        .header p {
            margin: 5px 0;
            font-size: 1.1em;
            color: #333;
        }
        .paper-ref {
            background: rgba(255,255,255,0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 0.95em;
            color: #333;
        }
        .content-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin: 25px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .content-section h2 {
            color: #FCD1D2;
            border-bottom: 3px solid #FCD1D2;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .content-section h3 {
            color: #DCCBD8;
            margin-top: 25px;
        }
        
        .architecture-diagram {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 40px 0;
            flex-wrap: wrap;
        }
        
        .component {
            background: white;
            border: 2px solid #ddd;
            border-radius: 12px;
            padding: 20px;
            margin: 10px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .component:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .transformer {
            background: linear-gradient(135deg, #9fB7E6 0%, #BCDAEE 100%);
            color: white;
            width: 150px;
            height: 100px;
            border: none;
        }
        
        .decoder-gene {
            background: linear-gradient(135deg, #FCD1D2 0%, #DCCBD8 100%);
            color: white;
            width: 140px;
            height: 80px;
            border: none;
        }
        
        .decoder-count {
            background: linear-gradient(135deg, #BCDAEE 0%, #FCED92 100%);
            color: white;
            width: 140px;
            height: 80px;
            border: none;
        }
        
        .arrow {
            font-size: 2em;
            color: #666;
            margin: 0 10px;
            display: flex;
            align-items: center;
        }
        
        .concept-box {
            background: #f8f9fa;
            border-left: 5px solid #FCD1D2;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .concept-box.gene {
            border-left-color: #FCD1D2;
        }
        
        .concept-box.count {
            border-left-color: #BCDAEE;
        }
        
        .concept-box.joint {
            border-left-color: #FCED92;
        }
        
        .concept-box.theory {
            border-left-color: #9fB7E6;
        }
        
        .concept-box.compute {
            border-left-color: #DCCBD8;
        }
        
        .math-formula {
            background: #2d2d2d;
            color: #f8f8f2;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            text-align: center;
        }
        
        .highlight-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .highlight-box strong {
            color: #856404;
        }
        
        .interactive-demo {
            background: linear-gradient(135deg, #BCDAEE 0%, #9fB7E6 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin: 30px 0;
            text-align: center;
        }
        
        .demo-controls {
            margin: 20px 0;
        }
        
        .demo-button {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 10px 20px;
            border-radius: 20px;
            margin: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .demo-button:hover, .demo-button.active {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        .demo-output {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
        }
        
        .probability-bar {
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
            height: 8px;
            margin: 5px 0;
            overflow: hidden;
        }
        
        .probability-fill {
            background: white;
            height: 100%;
            transition: width 0.5s ease;
        }
        
        .gene-token {
            display: inline-block;
            background: rgba(252, 209, 210, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            margin: 2px;
            font-size: 0.9em;
        }
        
        .count-value {
            display: inline-block;
            background: rgba(188, 218, 238, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            margin: 2px;
            font-size: 0.9em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #FCD1D2 0%, #DCCBD8 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-card .number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-card .label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .back-link {
            display: inline-block;
            margin: 20px 0;
            padding: 10px 20px;
            background: #FCD1D2;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .back-link:hover {
            background: #DCCBD8;
            transform: translateX(-5px);
        }

        ul, ol {
            line-height: 1.8;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            .architecture-diagram {
                flex-direction: column;
            }
            .arrow {
                transform: rotate(90deg);
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <ul class="navbar-nav">
                <li><a href="../index.html" class="home-link"><i class="fas fa-book"></i> AI4Bio Concepts Handbook</a></li>
                <li><a href="../../"><i class="fas fa-home"></i> Xinru's Homepage</a></li>
            </ul>
        </div>
    </nav>

    <main role="main">
        <div class="container">
            <div class="header">
                <h1><i class="fas fa-project-diagram"></i> TranscriptFormer Dual Decoder Heads</h1>
                <p>Understanding how the model jointly predicts genes and their expression counts</p>
                <div class="paper-ref">
                    <strong>Source:</strong> Core architecture component for generative single-cell modeling<br>
                    <em>Part of foundation model design for transcriptomics</em>
                </div>
            </div>

            <!-- Core Architecture -->
            <div class="content-section">
                <h2><i class="fas fa-sitemap"></i> Architecture Overview</h2>
                
                <div class="architecture-diagram">
                    <div class="component transformer" id="transformer">
                        <h4>Transformer<br>Encoder</h4>
                        <p>z<sub>j</sub><sup>(L)</sup></p>
                    </div>
                    
                    <div class="arrow">→</div>
                    
                    <div class="component decoder-gene" id="gene-decoder">
                        <h4>Gene<br>Decoder</h4>
                        <p>Categorical</p>
                    </div>
                    
                    <div class="component decoder-count" id="count-decoder">
                        <h4>Count<br>Decoder</h4>
                        <p>Zero-Truncated<br>Poisson</p>
                    </div>
                </div>

                <div class="highlight-box">
                    <strong><i class="fas fa-lightbulb"></i> Core Innovation:</strong> 
                    Unlike discriminative models that only classify, this dual-decoder architecture can generate realistic cell profiles by sampling from both gene identity and count distributions sequentially.
                </div>
            </div>

            <!-- Gene Decoder -->
            <div class="content-section">
                <h2><i class="fas fa-dna"></i> Gene Decoder Head (Categorical)</h2>
                
                <div class="concept-box gene">
                    <h3>Purpose</h3>
                    <p>Predicts <strong>which gene</strong> to select next in the cell sentence</p>
                </div>

                <h3>Mathematical Formulation</h3>
                <div class="math-formula">
                    ω<sub>j</sub> = softmax(MLP<sub>ω</sub>(z<sub>j</sub><sup>(L)</sup>))
                </div>
                
                <h3>Key Properties</h3>
                <ul>
                    <li><strong>Output:</strong> Probability distribution over entire gene vocabulary (~25K-247K genes)</li>
                    <li><strong>Architecture:</strong> Two-layer MLP + softmax normalization</li>
                    <li><strong>Loss:</strong> Standard categorical cross-entropy</li>
                    <li><strong>Context-aware:</strong> Depends on all previously selected genes</li>
                </ul>
                
                <h3>Example Output</h3>
                <div class="concept-box">
                    <p><strong>Gene Selection Probabilities:</strong></p>
                    <div style="background: #ffeaa7; padding: 10px; border-radius: 8px; margin: 10px 0;">
                        <span class="gene-token">GAPDH: 0.23</span>
                        <span class="gene-token">ACTB: 0.18</span>
                        <span class="gene-token">TP53: 0.12</span>
                        <span class="gene-token">MYC: 0.08</span>
                        <span class="gene-token">Others: 0.39</span>
                    </div>
                    <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                        The model assigns highest probability to housekeeping genes like GAPDH and ACTB, which are typically highly expressed in most cells.
                    </p>
                </div>
            </div>

            <!-- Count Decoder -->
            <div class="content-section">
                <h2><i class="fas fa-chart-bar"></i> Count Decoder Head (Zero-Truncated Poisson)</h2>
                
                <div class="concept-box count">
                    <h3>Purpose</h3>
                    <p>Predicts <strong>expression level (count)</strong> for the selected gene</p>
                </div>

                <h3>Mathematical Formulation</h3>
                <div class="math-formula">
                    P(c<sub>j</sub> | g<sub>j</sub>, context) = ZTP(λ<sub>j</sub>)
                    <br><br>
                    P(c = k | λ) = (λ<sup>k</sup> e<sup>-λ</sup>) / (k!(1 - e<sup>-λ</sup>)), k ≥ 1
                </div>
                
                <h3>Key Properties</h3>
                <ul>
                    <li><strong>Output:</strong> Expected count value (always > 0)</li>
                    <li><strong>Architecture:</strong> MLP with normalization to total count</li>
                    <li><strong>Loss:</strong> Zero-truncated Poisson negative log-likelihood</li>
                    <li><strong>Constraint:</strong> Counts sum to observed total transcripts in cell</li>
                </ul>
                
                <h3>Example Output</h3>
                <div class="concept-box">
                    <p><strong>Predicted Expression Counts:</strong></p>
                    <div style="background: #74b9ff; padding: 10px; border-radius: 8px; margin: 10px 0; color: white;">
                        <span class="count-value">GAPDH: 156</span>
                        <span class="count-value">ACTB: 89</span>
                        <span class="count-value">TP53: 23</span>
                        <span class="count-value">MYC: 45</span>
                    </div>
                    <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                        Count predictions reflect realistic expression levels, with housekeeping genes showing higher counts than regulatory genes.
                    </p>
                </div>

                <div class="concept-box theory">
                    <h3>Why Zero-Truncated Poisson?</h3>
                    <p><strong>Biological Motivation:</strong></p>
                    <ul>
                        <li>Gene expression counts are discrete, non-negative integers</li>
                        <li>Poisson distribution naturally models count data</li>
                        <li><strong>Zero-truncation ensures only expressed genes appear in sequences</strong></li>
                        <li>Captures overdispersion common in single-cell data</li>
                    </ul>
                </div>
            </div>

            <!-- Joint Training -->
            <div class="content-section">
                <h2><i class="fas fa-link"></i> Joint Training & Coupling</h2>
                
                <div class="concept-box joint">
                    <h3>Why Both Heads Are Essential</h3>
                    
                    <div class="math-formula">
                        L = L<sub>gene</sub> + L<sub>count</sub>
                    </div>
                    
                    <ul>
                        <li><strong>Sequential Dependency:</strong> Count decoder uses gene identity from gene decoder</li>
                        <li><strong>Biological Realism:</strong> Models the fact that different genes have different typical expression levels</li>
                        <li><strong>Generative Capability:</strong> Can sample both gene identity and count jointly</li>
                        <li><strong>Context Sensitivity:</strong> Both decoders condition on cell context</li>
                    </ul>
                </div>

                <h3>Training Process</h3>
                <ol>
                    <li><strong>Forward Pass:</strong> Transformer encodes cell context → Both decoders make predictions</li>
                    <li><strong>Loss Computation:</strong> Calculate cross-entropy (gene) + ZTP NLL (count)</li>
                    <li><strong>Backpropagation:</strong> Gradients flow through both heads to shared encoder</li>
                    <li><strong>Joint Optimization:</strong> Both tasks improve together through shared representations</li>
                </ol>

                <div class="highlight-box">
                    <strong><i class="fas fa-check-circle"></i> Key Advantage:</strong> 
                    Joint training ensures that gene selection and count prediction are coherent—the model learns that certain genes (like GAPDH) typically have high counts, while others (like transcription factors) have low counts.
                </div>
            </div>

            <!-- Interactive Demo -->
            <div class="content-section">
                <h2><i class="fas fa-gamepad"></i> Interactive Generation Demo</h2>
                
                <div class="interactive-demo">
                    <h3>🎮 See How Dual Decoders Work Together</h3>
                    <p>Step through the generation process for a single token in a cell sentence</p>
                    
                    <div class="demo-controls">
                        <button class="demo-button" id="step1">Step 1: Select Gene</button>
                        <button class="demo-button" id="step2">Step 2: Predict Count</button>
                        <button class="demo-button" id="reset">Reset Demo</button>
                    </div>
                    
                    <div class="demo-output" id="demo-display">
                        <div><strong>Cell Sentence Generation:</strong></div>
                        <div id="current-sentence">🧬 [START] → </div>
                        <div id="probabilities" style="margin-top: 15px;"></div>
                    </div>
                </div>
            </div>

            <!-- Computational Advantages -->
            <div class="content-section">
                <h2><i class="fas fa-tachometer-alt"></i> Computational Advantages</h2>
                
                <div class="concept-box compute">
                    <h3>Efficiency Benefits</h3>
                    <ul>
                        <li><strong>Shared Encoder:</strong> Single transformer processes both tasks</li>
                        <li><strong>Parallel Computation:</strong> Both losses computed simultaneously during training</li>
                        <li><strong>Parameter Sharing:</strong> Contextualized representations used by both heads</li>
                        <li><strong>End-to-End Training:</strong> Joint optimization improves both tasks</li>
                    </ul>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="number">2x</div>
                        <div class="label">More efficient than separate models</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">1</div>
                        <div class="label">Shared transformer encoder</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">2</div>
                        <div class="label">Specialized decoder heads</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">~50K</div>
                        <div class="label">Gene vocabulary size</div>
                    </div>
                </div>

                <div class="highlight-box">
                    <strong><i class="fas fa-info-circle"></i> Comparison:</strong> 
                    Training gene and count predictors separately would require 2x the encoder parameters and 2x the training time, with worse performance due to lack of shared representations.
                </div>
            </div>

            <!-- Applications -->
            <div class="content-section">
                <h2><i class="fas fa-flask"></i> Applications & Use Cases</h2>
                
                <h3>Generation Tasks</h3>
                <div class="concept-box">
                    <ul>
                        <li><strong>Cell State Simulation:</strong> Generate synthetic cells matching specific phenotypes</li>
                        <li><strong>Perturbation Prediction:</strong> Predict cell response to genetic/drug perturbations</li>
                        <li><strong>Data Augmentation:</strong> Create realistic training data for downstream tasks</li>
                        <li><strong>Trajectory Modeling:</strong> Generate intermediate cell states along differentiation paths</li>
                    </ul>
                </div>

                <h3>Analysis Tasks</h3>
                <div class="concept-box">
                    <ul>
                        <li><strong>Cell Type Annotation:</strong> Use learned representations for classification</li>
                        <li><strong>Gene Importance:</strong> Analyze which genes have high prediction probability</li>
                        <li><strong>Expression Pattern Discovery:</strong> Identify co-expression patterns from count predictions</li>
                        <li><strong>Quality Control:</strong> Detect anomalous cells based on reconstruction likelihood</li>
                    </ul>
                </div>
            </div>

            <!-- Related Concepts -->
            <div class="content-section">
                <h2><i class="fas fa-link"></i> Related Concepts</h2>
                
                <div class="concept-box">
                    <h3>In This Handbook:</h3>
                    <ul>
                        <li><strong>Foundation Models:</strong> 
                            <a href="self-verification-agents.html">Self-Verification Agents</a> - 
                            How LLMs verify their outputs using external knowledge
                        </li>
                        <li><strong>Foundation Models:</strong> 
                            <a href="attention-mechanisms.html">Attention Mechanisms</a> (Coming Soon) - 
                            Understanding transformer architectures
                        </li>
                    </ul>
                </div>

                <div class="concept-box">
                    <h3>Key Technical Concepts:</h3>
                    <ul>
                        <li><strong>Autoregressive Generation:</strong> Sequential sampling where each token depends on previous tokens</li>
                        <li><strong>Multi-Task Learning:</strong> Training single model on multiple related tasks with shared representations</li>
                        <li><strong>Zero-Truncated Distributions:</strong> Statistical distributions excluding zero values</li>
                        <li><strong>Sequence-to-Sequence Models:</strong> Architectures for generating output sequences from input sequences</li>
                    </ul>
                </div>
            </div>

            <!-- Implementation Notes -->
            <div class="content-section">
                <h2><i class="fas fa-code"></i> Implementation Considerations</h2>
                
                <h3>Design Decisions</h3>
                <ol>
                    <li><strong>Vocabulary Size:</strong> Balance between gene coverage and computational efficiency</li>
                    <li><strong>MLP Architecture:</strong> Typically 2-layer networks with ReLU activations</li>
                    <li><strong>Loss Weighting:</strong> May need to balance gene vs. count loss terms</li>
                    <li><strong>Normalization:</strong> Ensure count predictions sum to observed library size</li>
                </ol>

                <h3>Common Challenges</h3>
                <div class="concept-box">
                    <ul>
                        <li><strong>Class Imbalance:</strong> Rare genes get low prediction probability (address with sampling strategies)</li>
                        <li><strong>Count Distribution:</strong> Heavy-tailed expression distributions require careful modeling</li>
                        <li><strong>Computational Cost:</strong> Large vocabulary requires efficient softmax implementations</li>
                        <li><strong>Memory Requirements:</strong> Storing embeddings for all genes can be memory-intensive</li>
                    </ul>
                </div>
            </div>

            <a href="../index.html" class="back-link">
                <i class="fas fa-arrow-left"></i> Back to AI4Bio Concepts Handbook
            </a>
        </div>
    </main>

    <script>
        // Interactive Demo
        let currentStep = 0;
        const genes = ['GAPDH', 'ACTB', 'TP53', 'MYC'];
        const counts = [156, 89, 23, 45];
        
        document.getElementById('step1').addEventListener('click', function() {
            currentStep = 1;
            this.classList.add('active');
            document.getElementById('step2').classList.remove('active');
            
            const selectedGene = genes[Math.floor(Math.random() * genes.length)];
            document.getElementById('current-sentence').innerHTML = 
                `🧬 [START] → <span class="gene-token">${selectedGene}</span>`;
            
            document.getElementById('probabilities').innerHTML = `
                <strong>Gene Decoder Output:</strong><br>
                Selected: <span class="gene-token">${selectedGene}</span><br>
                <small>Probability: ${(Math.random() * 0.3 + 0.1).toFixed(3)}</small>
            `;
        });
        
        document.getElementById('step2').addEventListener('click', function() {
            if (currentStep === 0) {
                alert('Please complete Step 1 first!');
                return;
            }
            currentStep = 2;
            this.classList.add('active');
            
            const count = counts[Math.floor(Math.random() * counts.length)];
            const geneSentence = document.getElementById('current-sentence').innerHTML;
            document.getElementById('current-sentence').innerHTML = 
                geneSentence + ` <span class="count-value">[${count}]</span>`;
            
            document.getElementById('probabilities').innerHTML += `
                <br><br><strong>Count Decoder Output:</strong><br>
                Predicted count: <span class="count-value">${count}</span><br>
                <small>λ (rate parameter): ${(count * 0.8).toFixed(2)}</small>
            `;
        });
        
        document.getElementById('reset').addEventListener('click', function() {
            currentStep = 0;
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step2').classList.remove('active');
            document.getElementById('current-sentence').innerHTML = '🧬 [START] → ';
            document.getElementById('probabilities').innerHTML = '';
        });
    </script>
</body>
</html>

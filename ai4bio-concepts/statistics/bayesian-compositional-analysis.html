<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bayesian Compositional Data Analysis - AI4Bio Concepts</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Lato', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            line-height: 1.8;
            color: #333;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        .navbar {
            background-color: #ffffff;
            border-bottom: 1px solid #e7e7e7;
            padding: 10px 0;
        }
        .navbar-nav {
            list-style-type: none;
            padding: 0;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .navbar-nav li {
            margin: 0 15px;
        }
        .navbar-nav a {
            color: #666666;
            text-decoration: none;
            font-weight: bold;
            font-size: 16px;
        }
        .home-link {
            color: #4E7AC2 !important;
        }
        .header {
            background: linear-gradient(135deg, #4E7AC2 0%, #455E85 100%);
            color: white;
            padding: 40px;
            border-radius: 15px;
            margin: 30px 0;
            text-align: center;
        }
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 2.5em;
        }
        .header p {
            margin: 5px 0;
            font-size: 1.1em;
            opacity: 0.9;
        }
        .paper-ref {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 0.95em;
        }
        .content-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin: 25px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .content-section h2 {
            color: #426DB4;
            border-bottom: 3px solid #426DB4;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .content-section h3 {
            color: #455E85;
            margin-top: 25px;
        }
        .concept-box {
            background: #f8f9fa;
            border-left: 5px solid #4E7AC2;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .concept-box.challenge {
            border-left-color: #f39c12;
        }
        .concept-box.prior {
            border-left-color: #9b59b6;
        }
        .concept-box.likelihood {
            border-left-color: #426DB4;
        }
        .concept-box.inference {
            border-left-color: #27ae60;
        }
        .highlight-box {
            background: #d4edda;
            border: 1px solid #28a745;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .highlight-box strong {
            color: #155724;
        }
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .warning-box strong {
            color: #856404;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .comparison-table th {
            background: linear-gradient(135deg, #4E7AC2 0%, #455E85 100%);
            color: white;
        }
        .comparison-table tr:hover {
            background: #f5f5f5;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #4E7AC2 0%, #455E85 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-card .number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-card .label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .timeline {
            position: relative;
            padding: 20px 0;
            margin: 30px 0;
        }
        .timeline-item {
            position: relative;
            padding-left: 60px;
            margin-bottom: 30px;
        }
        .timeline-icon {
            position: absolute;
            left: 0;
            width: 40px;
            height: 40px;
            background: #4E7AC2;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .timeline-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #426DB4;
        }
        .method-card {
            background: white;
            border: 2px solid #4E7AC2;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .method-card h4 {
            color: #426DB4;
            margin-top: 0;
        }
        .pros-cons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .pros, .cons {
            padding: 15px;
            border-radius: 8px;
        }
        .pros {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }
        .cons {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        .back-link {
            display: inline-block;
            margin: 20px 0;
            padding: 10px 20px;
            background: #4E7AC2;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .back-link:hover {
            background: #455E85;
            transform: translateX(-5px);
        }
        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 10px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
            margin: 15px 0;
        }
        .code-block .comment {
            color: #75715e;
        }
        .code-block .keyword {
            color: #f92672;
        }
        .code-block .string {
            color: #e6db74;
        }
        .formula {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            text-align: center;
            font-family: 'Times New Roman', serif;
            font-size: 1.1em;
            border: 2px solid #426DB4;
        }
        .model-diagram {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #4E7AC2;
        }
        .distribution-box {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            .pros-cons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <ul class="navbar-nav">
                <li><a href="../index.html" class="home-link"><i class="fas fa-book"></i> AI4Bio Concepts Handbook</a></li>
                <li><a href="../../"><i class="fas fa-home"></i> Xinru's Homepage</a></li>
            </ul>
        </div>
    </nav>

    <main role="main">
        <div class="container">
            <div class="header">
                <h1><i class="fas fa-chart-pie"></i> Bayesian Hierarchical Modeling for Compositional Data</h1>
                <p>How to analyze cell-type composition changes using Bayesian inference</p>
                <div class="paper-ref">
                    <strong>Key Example:</strong> scCODA (Büttner et al. 2021) uses Dirichlet-Multinomial + spike-and-slab priors to detect compositional changes in single-cell data with automatic FDR control
                </div>
            </div>

            <!-- The Problem -->
            <div class="content-section">
                <h2><i class="fas fa-exclamation-triangle"></i> The Compositional Data Problem</h2>
                
                <div class="concept-box challenge">
                    <h3>Why Standard Statistical Tests Fail</h3>
                    <p><strong>Core Problem:</strong> Single-cell RNA-seq data is compositional - you measure relative proportions, not absolute counts. This creates a negative correlation bias that inflates false discoveries.</p>
                </div>

                <h3>The Compositional Constraint</h3>
                <div class="warning-box">
                    <strong><i class="fas fa-balance-scale"></i> Zero-Sum Constraint:</strong> 
                    If you sequence 10,000 cells per sample, the cell-type proportions must sum to 1.0 (or 100%). This means:
                    <ul>
                        <li>If one cell type increases, others must decrease (even if they're unchanged biologically)</li>
                        <li>All cell-type proportions are negatively correlated by construction</li>
                        <li>Testing each cell type independently leads to false positives</li>
                    </ul>
                </div>

                <h3>Real-World Example</h3>
                <div class="concept-box">
                    <p><strong>Scenario:</strong> You have immune cells from healthy vs. disease samples</p>
                    <ul>
                        <li><strong>Truth:</strong> Only B cells decrease in disease (e.g., from 20% to 5%)</li>
                        <li><strong>What you observe:</strong> T cells "increase" from 30% to 37.5%, Monocytes "increase" from 40% to 50%, etc.</li>
                        <li><strong>Problem:</strong> A t-test on each cell type independently will call T cells and Monocytes as significantly changed!</li>
                        <li><strong>Reality:</strong> They only appear to increase because B cells decreased</li>
                    </ul>
                </div>

                <h3>Why Compositional Analysis is Hard</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="number">Low n</div>
                        <div class="label">scRNA-seq: 2-10 samples per condition</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">Proportional</div>
                        <div class="label">Constrained to sum to 1</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">Negative Bias</div>
                        <div class="label">Spurious correlations</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">Multiple Testing</div>
                        <div class="label">10-50 cell types tested</div>
                    </div>
                </div>

                <h3>Failed Approaches</h3>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Method</th>
                            <th>Approach</th>
                            <th>Why It Fails</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>t-test on proportions</strong></td>
                            <td>Test each cell type independently</td>
                            <td>Ignores compositional constraint → inflated FDR</td>
                        </tr>
                        <tr>
                            <td><strong>Poisson regression</strong></td>
                            <td>Model counts as Poisson</td>
                            <td>Doesn't account for compositionality</td>
                        </tr>
                        <tr>
                            <td><strong>Wilcoxon rank-sum</strong></td>
                            <td>Non-parametric test per cell type</td>
                            <td>Still tests independently, ignores constraint</td>
                        </tr>
                        <tr>
                            <td><strong>Chi-square test</strong></td>
                            <td>Test overall composition difference</td>
                            <td>Can't identify which cell types changed</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Bayesian Solution -->
            <div class="content-section">
                <h2><i class="fas fa-lightbulb"></i> The Bayesian Hierarchical Solution</h2>
                
                <div class="concept-box">
                    <h3>Three Key Ideas</h3>
                    <ol>
                        <li><strong>Model all cell types jointly</strong> - Use a multivariate distribution that respects the compositional constraint</li>
                        <li><strong>Bayesian inference</strong> - Naturally handles uncertainty, works with small samples (even n=1!)</li>
                        <li><strong>Automatic variable selection</strong> - Spike-and-slab priors identify which cell types changed</li>
                    </ol>
                </div>

                <h3>The scCODA Model Structure</h3>
                <div class="model-diagram">
                    <h4>Hierarchical Model Components</h4>
                    
                    <div class="distribution-box">
                        <strong>1. Likelihood (Data Model):</strong>
                        <div class="formula">
                            Y ~ DirMult(ϕ, y)
                        </div>
                        <p><strong>Y:</strong> Cell type counts (N samples × K cell types)</p>
                        <p><strong>ϕ:</strong> Cell type proportions</p>
                        <p><strong>y:</strong> Total cells per sample</p>
                        <p><em>Why Dirichlet-Multinomial?</em> Accounts for overdispersion and uncertainty in proportions</p>
                    </div>

                    <div class="distribution-box">
                        <strong>2. Link Function:</strong>
                        <div class="formula">
                            log(ϕ) = α + Xβ
                        </div>
                        <p><strong>α:</strong> Baseline log-proportions for each cell type</p>
                        <p><strong>X:</strong> Covariates (e.g., disease vs. healthy)</p>
                        <p><strong>β:</strong> Effect sizes (log-fold changes)</p>
                    </div>

                    <div class="distribution-box">
                        <strong>3. Priors (Regularization):</strong>
                        <div class="formula">
                            α_k ~ N(0, 5) for all cell types k<br>
                            β = τ ⊙ β̃ (element-wise product)<br>
                            τ_{m,k} = exp(t_{m,k}) / (1 + exp(t_{m,k})) [spike-and-slab]<br>
                            t_{m,k}/50 ~ N(0, 1)<br>
                            β̃_{m,k} = σ²_m · γ_{m,k}<br>
                            σ²_m ~ Half-Cauchy(1) [global scale]<br>
                            γ_{m,k} ~ N(0, 1) [standardized effect]
                        </div>
                    </div>
                </div>

                <h3>Understanding the Priors</h3>
                <div class="concept-box prior">
                    <h4>Spike-and-Slab Prior: Automatic Variable Selection</h4>
                    <p><strong>Goal:</strong> Automatically determine which cell types changed</p>
                    <p><strong>How it works:</strong></p>
                    <ul>
                        <li><strong>Slab (τ ≈ 1):</strong> Effect is included → β_{m,k} is nonzero</li>
                        <li><strong>Spike (τ ≈ 0):</strong> Effect is excluded → β_{m,k} ≈ 0</li>
                        <li>τ_{m,k} is learned from data via logit-normal prior</li>
                        <li>Equal prior probability (50/50) for inclusion vs. exclusion</li>
                    </ul>
                </div>

                <div class="concept-box prior">
                    <h4>Half-Cauchy Prior: Global Shrinkage</h4>
                    <p><strong>Goal:</strong> Control overall effect sizes</p>
                    <p><strong>Why Half-Cauchy?</strong></p>
                    <ul>
                        <li>Heavy-tailed → allows large effects when warranted</li>
                        <li>Shrinks small effects toward zero</li>
                        <li>Recommended for hierarchical models (Polson & Scott 2012)</li>
                    </ul>
                </div>

                <h3>Reference Cell Type Selection</h3>
                <div class="warning-box">
                    <strong><i class="fas fa-anchor"></i> Compositional Reference Requirement:</strong>
                    Compositional data analysis requires a reference cell type. All detected changes are interpreted relative to this reference.
                    <br><br>
                    <strong>Automatic Selection:</strong> scCODA chooses the cell type with:
                    <ul>
                        <li>Least dispersion in relative abundance across samples</li>
                        <li>Present in ≥95% of samples (avoid rare cell types)</li>
                    </ul>
                    <strong>Manual Selection:</strong> Choose a cell type known to be unaffected by the condition
                </div>
            </div>

            <!-- Inference -->
            <div class="content-section">
                <h2><i class="fas fa-cogs"></i> Bayesian Inference: Hamiltonian Monte Carlo</h2>
                
                <div class="concept-box inference">
                    <h3>Why HMC Instead of Other MCMC Methods?</h3>
                    <p><strong>Hamiltonian Monte Carlo (HMC)</strong> is a gradient-based MCMC algorithm that:</p>
                    <ul>
                        <li>Explores the posterior efficiently (fewer samples needed)</li>
                        <li>Reduces random walk behavior of Metropolis-Hastings</li>
                        <li>Automatically tunes step sizes</li>
                        <li>Handles high-dimensional parameter spaces better</li>
                    </ul>
                </div>

                <h3>HMC Settings in scCODA</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="number">20,000</div>
                        <div class="label">Total HMC iterations</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">5,000</div>
                        <div class="label">Burn-in (discarded)</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">10</div>
                        <div class="label">Leapfrog steps per iteration</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">Auto</div>
                        <div class="label">Step size adjustment</div>
                    </div>
                </div>

                <h3>The HMC Algorithm</h3>
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-icon">1</div>
                        <div class="timeline-content">
                            <h4>Initialize Parameters</h4>
                            <p>α, γ ~ N(0,1); t = 0; σ² = 1</p>
                        </div>
                    </div>
                    
                    <div class="timeline-item">
                        <div class="timeline-icon">2</div>
                        <div class="timeline-content">
                            <h4>Simulate Hamiltonian Dynamics</h4>
                            <p>Use gradients of log-posterior to propose new parameters</p>
                        </div>
                    </div>
                    
                    <div class="timeline-item">
                        <div class="timeline-icon">3</div>
                        <div class="timeline-content">
                            <h4>Metropolis Acceptance</h4>
                            <p>Accept/reject proposed parameters based on energy change</p>
                        </div>
                    </div>
                    
                    <div class="timeline-item">
                        <div class="timeline-icon">4</div>
                        <div class="timeline-content">
                            <h4>Repeat for 20,000 Iterations</h4>
                            <p>Collect samples from posterior distribution</p>
                        </div>
                    </div>
                </div>

                <h3>Post-Processing: Calculating Inclusion Probabilities</h3>
                <div class="concept-box">
                    <p>After HMC sampling, scCODA calculates:</p>
                    <div class="formula">
                        P_inc(β_{m,k}) = (1/H) Σ I(|β_{m,k,h}| ≥ 10⁻³)
                    </div>
                    <p><strong>H:</strong> Number of HMC iterations</p>
                    <p><strong>I:</strong> Indicator function (1 if condition true, 0 otherwise)</p>
                    <p><strong>Interpretation:</strong> Proportion of MCMC samples where effect was included (τ > 0)</p>
                </div>
            </div>

            <!-- FDR Control -->
            <div class="content-section">
                <h2><i class="fas fa-shield-alt"></i> False Discovery Rate Control</h2>
                
                <div class="concept-box">
                    <h3>Direct Posterior Probability Approach</h3>
                    <p><strong>Key Innovation:</strong> Use posterior inclusion probabilities directly to control FDR (no p-values!)</p>
                </div>

                <h3>How It Works</h3>
                <ol>
                    <li><strong>Calculate inclusion probability</strong> P_inc(β_{m,k}) for each effect</li>
                    <li><strong>Calculate type I error probability:</strong> 1 - P_inc(β_{m,k})</li>
                    <li><strong>Rank all effects</strong> by type I error probability (ascending)</li>
                    <li><strong>For threshold c, define credible set:</strong> J(c) = {β_{m,k} | 1 - P_inc(β_{m,k}) ≤ c}</li>
                    <li><strong>Calculate FDR for threshold c:</strong></li>
                </ol>

                <div class="formula">
                    FDR(c) = Σ_{β ∈ J(c)} [1 - P_inc(β)] / |J(c)|
                </div>

                <ol start="6">
                    <li><strong>Find optimal threshold c*:</strong></li>
                </ol>

                <div class="formula">
                    c* = min_{0<c<1, FDR(c)<α} c
                </div>

                <p>Where α is the desired FDR level (typically 0.05 or 0.2)</p>

                <div class="highlight-box">
                    <strong><i class="fas fa-check-circle"></i> Advantages of This Approach:</strong>
                    <ul>
                        <li>No arbitrary p-value thresholds</li>
                        <li>Directly controls FDR at desired level</li>
                        <li>Accounts for multiplicity automatically</li>
                        <li>Works even with n=1 sample per group!</li>
                    </ul>
                </div>

                <h3>Reporting Credible Effects</h3>
                <div class="concept-box">
                    <p>scCODA reports:</p>
                    <ul>
                        <li><strong>Credible effects:</strong> J(c*) = set of cell types with credible changes</li>
                        <li><strong>Effect sizes:</strong> Mean of β_{m,k} across MCMC samples where it was nonzero</li>
                        <li><strong>Credible intervals:</strong> 95% HDI (High-Density Interval) excluding spike samples</li>
                    </ul>
                </div>
            </div>


            <!-- Performance -->
            <div class="content-section">
                <h2><i class="fas fa-trophy"></i> Benchmark Performance</h2>
                
                <h3>scCODA vs. Other Methods (Synthetic Data)</h3>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Method</th>
                            <th>Type</th>
                            <th>MCC (n=2)</th>
                            <th>FDR Control</th>
                            <th>Works n=1?</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background: #d4edda;">
                            <td><strong>scCODA</strong></td>
                            <td>Bayesian compositional</td>
                            <td><strong>0.64</strong></td>
                            <td><strong>✓ Yes (0.05)</strong></td>
                            <td><strong>✓ Yes</strong></td>
                        </tr>
                        <tr>
                            <td><strong>Standard DirMult</strong></td>
                            <td>Bayesian compositional</td>
                            <td>0.58</td>
                            <td>× No (0.10)</td>
                            <td>✓ Yes</td>
                        </tr>
                        <tr>
                            <td><strong>ALDEx2</strong></td>
                            <td>Compositional (CLR transform)</td>
                            <td>0.45</td>
                            <td>✓ Yes (0.05)</td>
                            <td>× No</td>
                        </tr>
                        <tr>
                            <td><strong>ANCOM-BC</strong></td>
                            <td>Compositional</td>
                            <td>0.40</td>
                            <td>× No (0.15)</td>
                            <td>× No</td>
                        </tr>
                        <tr>
                            <td><strong>ANCOM</strong></td>
                            <td>Compositional</td>
                            <td>0.38</td>
                            <td>× No (0.18)</td>
                            <td>× No</td>
                        </tr>
                        <tr>
                            <td><strong>Harmony</strong></td>
                            <td>Non-compositional</td>
                            <td>0.30</td>
                            <td>× No (0.25)</td>
                            <td>× No</td>
                        </tr>
                        <tr>
                            <td><strong>t-test</strong></td>
                            <td>Non-compositional</td>
                            <td>0.25</td>
                            <td>× No (0.30)</td>
                            <td>× No</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Key Performance Metrics</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="number">0.99</div>
                        <div class="label">AUC (sensitivity)</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">0.94</div>
                        <div class="label">Average Precision</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">0.64</div>
                        <div class="label">MCC (overall performance)</div>
                    </div>
                    <div class="stat-card">
                        <div class="number">0.05</div>
                        <div class="label">Actual FDR (target: 0.05)</div>
                    </div>
                </div>

                <h3>Real Data Validation</h3>
                <div class="method-card">
                    <h4>Case Study 1: Supercentenarians (Hashimoto et al. 2019)</h4>
                    <p><strong>Dataset:</strong> PBMCs from 7 supercentenarians vs 5 young controls</p>
                    <p><strong>Ground truth:</strong> B cells decrease (validated by FACS)</p>
                    <p><strong>Results:</strong></p>
                    <ul>
                        <li>✓ scCODA: Correctly identified B cell decrease</li>
                        <li>✓ Wilcoxon: Also found B cell decrease</li>
                        <li><strong>Advantage:</strong> scCODA provides probabilistic interpretation + FDR control</li>
                    </ul>
                </div>

                <div class="method-card">
                    <h4>Case Study 2: Alzheimer's Disease Microglia (Keren-Shaul et al. 2017)</h4>
                    <p><strong>Dataset:</strong> 3 microglia types, n=2 per condition (AD vs WT), cortex & cerebellum</p>
                    <p><strong>Ground truth:</strong> Disease-associated microglia (DAM) increase in cortex (validated by staining)</p>
                    <p><strong>Results:</strong></p>
                    <ul>
                        <li>✓ scCODA: Credible increase in DAM and microglia 2 in cortex</li>
                        <li>✓ scCODA: No changes in cerebellum (correct - unaffected by AD)</li>
                        <li>× ANCOM: Called all 3 microglia types in cortex (false positives)</li>
                    </ul>
                </div>

                <div class="method-card">
                    <h4>Case Study 3: COVID-19 BAL (Liao et al. 2020)</h4>
                    <p><strong>Dataset:</strong> 4 healthy, 3 moderate, 6 severe COVID-19 patients</p>
                    <p><strong>scCODA findings (FDR 0.2):</strong></p>
                    <ul>
                        <li>✓ T cell depletion in moderate vs severe (confirmed in literature)</li>
                        <li>✓ NK cell increase in mild vs healthy (confirmed by FACS in other studies)</li>
                        <li>✓ Neutrophil increase in severe (well-established marker of severe COVID)</li>
                    </ul>
                    <p><strong>Original paper (t-test):</strong> Only found pDC changes after multiple testing correction</p>
                </div>
            </div>

            <!-- When to Use -->
            <div class="content-section">
                <h2><i class="fas fa-map-signs"></i> When to Use Bayesian Compositional Analysis</h2>
                
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Your Situation</th>
                            <th>Use scCODA?</th>
                            <th>Alternative</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background: #d4edda;">
                            <td>Low sample size (n=2-5 per group)</td>
                            <td><strong>✓ Yes - scCODA excels here</strong></td>
                            <td>ALDEx2 (but lower power)</td>
                        </tr>
                        <tr style="background: #d4edda;">
                            <td>Compositional data (cell types, microbiome)</td>
                            <td><strong>✓ Yes - required!</strong></td>
                            <td>ANCOM-BC, ALDEx2</td>
                        </tr>
                        <tr style="background: #d4edda;">
                            <td>Need FDR control</td>
                            <td><strong>✓ Yes - automatic</strong></td>
                            <td>ALDEx2</td>
                        </tr>
                        <tr style="background: #d4edda;">
                            <td>10-50 cell types</td>
                            <td><strong>✓ Yes - handles well</strong></td>
                            <td>Any compositional method</td>
                        </tr>
                        <tr>
                            <td>Very large sample size (n>50 per group)</td>
                            <td>⚠️ Works, but may be overkill</td>
                            <td>ALDEx2 faster</td>
                        </tr>
                        <tr>
                            <td>Non-compositional count data</td>
                            <td>× No - use appropriate model</td>
                            <td>DESeq2, edgeR</td>
                        </tr>
                        <tr>
                            <td>Need very fast results (seconds)</td>
                            <td>× No - HMC takes minutes</td>
                            <td>t-test (but loses accuracy)</td>
                        </tr>
                        <tr>
                            <td>More than 2 conditions</td>
                            <td>⚠️ Pairwise comparisons only</td>
                            <td>Run multiple pairwise tests</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Power Analysis: How Many Samples Do I Need?</h3>
                <div class="concept-box">
                    <p><strong>Rule of thumb for 80% power (FDR = 0.05):</strong></p>
                    <ul>
                        <li><strong>Large effect (log2FC = 4):</strong> n=2-3 samples per group (even for rare cell types!)</li>
                        <li><strong>Medium effect (log2FC = 2):</strong> n=3-5 samples for abundant, n=10-15 for rare cell types</li>
                        <li><strong>Small effect (log2FC = 1):</strong> n=5-10 samples for abundant, n=20-30 for rare cell types</li>
                    </ul>
                    <p><em>Abundant = 20% of cells; Rare = 2.5% of cells</em></p>
                </div>

                <div class="warning-box">
                    <strong><i class="fas fa-exclamation-triangle"></i> When Not to Use:</strong>
                    <ul>
                        <li>Absolute counts are available and meaningful (use negative binomial models)</li>
                        <li>You need to detect changes in < 50% of samples per group (scCODA may miss heterogeneous responses)</li>
                        <li>Very large datasets (>100 samples) where speed is critical (consider ALDEx2)</li>
                    </ul>
                </div>
            </div>

            <!-- Advantages & Limitations -->
            <div class="content-section">
                <h2><i class="fas fa-balance-scale"></i> Advantages & Limitations</h2>
                
                <div class="pros-cons">
                    <div class="pros">
                        <h4><i class="fas fa-check-circle"></i> Advantages</h4>
                        <ul>
                            <li><strong>Works with n=1</strong> - Bayesian inference doesn't require large samples</li>
                            <li><strong>Proper compositionality</strong> - Models all cell types jointly</li>
                            <li><strong>Automatic FDR control</strong> - No manual threshold selection</li>
                            <li><strong>Automatic variable selection</strong> - Spike-and-slab identifies changed cell types</li>
                            <li><strong>Probabilistic interpretation</strong> - Get credible intervals, not just p-values</li>
                            <li><strong>Handles overdispersion</strong> - Dirichlet-Multinomial > Multinomial</li>
                            <li><strong>Best performance</strong> - Outperforms all other methods in benchmarks</li>
                        </ul>
                    </div>
                    <div class="cons">
                        <h4><i class="fas fa-times-circle"></i> Limitations</h4>
                        <ul>
                            <li><strong>Computational cost</strong> - HMC slower than simple tests (minutes vs seconds)</li>
                            <li><strong>Requires reference</strong> - Need stable cell type (or use automatic)</li>
                            <li><strong>Pairwise only</strong> - Can't directly model >2 conditions</li>
                            <li><strong>Misses heterogeneous responses</strong> - Requires >50% samples to respond</li>
                            <li><strong>Requires cell type labels</strong> - Need well-defined clusters</li>
                            <li><strong>No continuous covariates</strong> - Current implementation binary only</li>
                            <li><strong>Linear assumption</strong> - Log-linear relationship assumed</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Best Practices -->
            <div class="content-section">
                <h2><i class="fas fa-check-square"></i> Best Practices</h2>
                
                <h3>Before Analysis</h3>
                <div class="concept-box">
                    <ol>
                        <li><strong>Check clustering quality</strong> - scCODA relies on accurate cell type labels</li>
                        <li><strong>Remove doublets</strong> - Clean data first using Scrublet or DoubletFinder</li>
                        <li><strong>Verify sample independence</strong> - Technical replicates don't count!</li>
                        <li><strong>Choose reference wisely</strong> - If possible, select a stable cell type known not to change</li>
                        <li><strong>Check for batch effects</strong> - Correct within-condition batches first</li>
                    </ol>
                </div>

                <h3>During Analysis</h3>
                <div class="concept-box">
                    <ol>
                        <li><strong>Check HMC convergence</strong> - Look at trace plots, R-hat statistics</li>
                        <li><strong>Increase iterations if needed</strong> - For many cell types (>30), use 40,000-80,000 iterations</li>
                        <li><strong>Try different FDR levels</strong> - Start with 0.05, increase to 0.2 for exploratory</li>
                        <li><strong>Test multiple references</strong> - Verify results are robust to reference choice</li>
                        <li><strong>Visualize before/after</strong> - Use boxplots to inspect raw proportions</li>
                    </ol>
                </div>

                <h3>After Analysis</h3>
                <div class="concept-box">
                    <ol>
                        <li><strong>Report credible intervals</strong> - Not just point estimates</li>
                        <li><strong>Validate key findings</strong> - FACS, immunohistochemistry, or independent cohort</li>
                        <li><strong>Check biological plausibility</strong> - Do the changes make sense?</li>
                        <li><strong>Report FDR level used</strong> - Be transparent about threshold</li>
                        <li><strong>Consider effect sizes</strong> - Statistical significance ≠ biological importance</li>
                    </ol>
                </div>

                <h3>Common Mistakes to Avoid</h3>
                <div class="warning-box">
                    <strong><i class="fas fa-exclamation-circle"></i> Don't:</strong>
                    <ul>
                        <li>Use technical replicates as biological replicates</li>
                        <li>Change reference after seeing results (p-hacking)</li>
                        <li>Ignore convergence diagnostics</li>
                        <li>Over-interpret small effect sizes (even if credible)</li>
                        <li>Forget that changes are relative to reference</li>
                        <li>Apply to non-compositional data</li>
                    </ul>
                </div>
            </div>

            <!-- Related Concepts -->
            <div class="content-section">
                <h2><i class="fas fa-link"></i> Related Concepts</h2>
                
                <div class="concept-box">
                    <h3>In This Handbook:</h3>
                    <ul>
                        <li><strong>Machine Learning:</strong> 
                            <a href="../machine-learning/batch-integration-metrics.html">Batch Integration Metrics</a> - 
                            Related quality control for single-cell data
                        </li>
                        <li><strong>Statistics:</strong> 
                            <a href="../statistics/distributions.html">Probability Distributions</a> - 
                            Understanding Dirichlet and Multinomial distributions
                        </li>
                        <li><strong>Computational Biology:</strong> 
                            <a href="../computational-biology/cross-species-integration.html">Cross-Species Integration</a> - 
                            Another compositional challenge in single-cell
                        </li>
                    </ul>
                </div>

                <div class="concept-box">
                    <h3>Key Papers:</h3>
                    <ul>
                        <li><strong>scCODA:</strong> Büttner et al. (2021). scCODA is a Bayesian model for compositional single-cell data analysis. <em>Nature Communications</em></li>
                        <li><strong>Compositional Data:</strong> Aitchison (1982). The statistical analysis of compositional data. <em>Journal of the Royal Statistical Society</em></li>
                        <li><strong>Spike-and-Slab:</strong> Scott & Berger (2010). Bayes and empirical-Bayes multiplicity adjustment. <em>Annals of Statistics</em></li>
                        <li><strong>Dirichlet-Multinomial:</strong> Wadsworth et al. (2017). An integrative Bayesian Dirichlet-multinomial regression model. <em>BMC Bioinformatics</em></li>
                        <li><strong>HMC:</strong> Betancourt et al. (2014). Optimizing the integrator step size for Hamiltonian Monte Carlo. arXiv preprint</li>
                    </ul>
                </div>

                <div class="concept-box">
                    <h3>Other Compositional Methods:</h3>
                    <ul>
                        <li><strong>ALDEx2:</strong> Uses centered log-ratio (CLR) transform + Monte Carlo sampling</li>
                        <li><strong>ANCOM:</strong> Analysis of Composition of Microbiomes (W statistic)</li>
                        <li><strong>ANCOM-BC:</strong> ANCOM with bias correction</li>
                        <li><strong>Dirichlet Regression:</strong> Frequentist compositional regression (used by Smillie et al.)</li>
                    </ul>
                </div>
            </div>

            <!-- Mathematical Details -->
            <div class="content-section">
                <h2><i class="fas fa-calculator"></i> Mathematical Details</h2>
                
                <h3>Complete Model Specification</h3>
                <div class="formula">
                    <strong>Likelihood:</strong><br>
                    Y ~ DirMult(ϕ, y)<br><br>
                    
                    <strong>Link function:</strong><br>
                    log(ϕ_{i,k}) = α_k + X_i β_k<br><br>
                    
                    <strong>Priors:</strong><br>
                    α_k ~ N(0, 5) for k ∈ [1, ..., K]<br>
                    β = τ ⊙ β̃<br>
                    τ_{m,k} = exp(t_{m,k}) / (1 + exp(t_{m,k}))<br>
                    t_{m,k}/50 ~ N(0, 1)<br>
                    β̃_{m,k} = σ²_m · γ_{m,k}<br>
                    σ²_m ~ Half-Cauchy(1)<br>
                    γ_{m,k} ~ N(0, 1)
                </div>

                <h3>Why These Choices?</h3>
                <div class="concept-box">
                    <h4>Dirichlet-Multinomial vs. Multinomial</h4>
                    <p><strong>Multinomial:</strong> Assumes fixed proportions ϕ</p>
                    <p><strong>Dirichlet-Multinomial:</strong> ϕ ~ Dirichlet(α) is random</p>
                    <p><strong>Why DirMult?</strong> Accounts for overdispersion (variance > mean) common in biological data</p>
                </div>

                <h3>Parameter Interpretation</h3>
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Interpretation</th>
                            <th>Scale</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>α_k</strong></td>
                            <td>Baseline log-proportion for cell type k</td>
                            <td>Log scale</td>
                        </tr>
                        <tr>
                            <td><strong>β_{m,k}</strong></td>
                            <td>Log-fold change for cell type k with covariate m</td>
                            <td>Log scale (log2 for interpretation)</td>
                        </tr>
                        <tr>
                            <td><strong>τ_{m,k}</strong></td>
                            <td>Inclusion indicator (0 = excluded, 1 = included)</td>
                            <td>[0, 1]</td>
                        </tr>
                        <tr>
                            <td><strong>σ²_m</strong></td>
                            <td>Global scale for covariate m effects</td>
                            <td>Positive reals</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <a href="../index.html" class="back-link"><i class="fas fa-arrow-left"></i> Back to Handbook</a>
        </div>
    </main>

    <footer>
        <div class="container" style="text-align: center; margin-top: 40px; padding: 20px; color: #666;">
            <p>Part of <a href="../../" style="color: #426DB4;">Xinru Qiu's</a> AI4Bio Concepts Handbook</p>
            <p style="font-size: 0.9em; margin-top: 10px;">Last updated: January 2025</p>
        </div>
    </footer>
</body>
</html>
